<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Momentum MAX</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            document.body.innerHTML = '<div style="background:#111; color:#ff5555; padding:20px; font-family:sans-serif; height:100vh;"><h1>‚ö†Ô∏è Crash Detected</h1><p>'+msg+'</p><p>Line: '+line+'</p><button onclick="localStorage.clear();window.location.reload()" style="padding:15px; background:white; border:none; border-radius:10px; font-weight:bold; margin-top:20px;">RESET APP DATA</button></div>';
        };
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;900&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- VISUAL ENGINE --- */
        :root { --primary: #8b5cf6; }
        * { font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; box-sizing: border-box; touch-action: manipulation; user-select: none; }
        [dir="rtl"] * { font-family: 'Tajawal', sans-serif; }
        
        body { 
            background-color: #f8fafc; 
            overscroll-behavior-y: none; 
            perspective: 1000px; 
            overflow-x: hidden;
        }

        /* 3D Cards */
        .card-3d-wrapper { perspective: 1000px; transform-style: preserve-3d; }
        .card-3d { 
            transition: transform 0.1s, box-shadow 0.3s; 
            transform-style: preserve-3d; 
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7)); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.6); 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); 
        }
        .card-3d:active { transform: scale(0.96) rotateX(2deg); }
        
        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes confetti { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(100vh) rotate(720deg); } }
        
        .animate-float { animation: float 6s ease-in-out infinite; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-slide { animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        
        .confetti { position: fixed; width: 10px; height: 10px; z-index: 100; pointer-events: none; }
        .blob { position: fixed; filter: blur(80px); z-index: -1; opacity: 0.6; animation: float 10s infinite; }
        .blob-1 { top: -20%; right: -20%; width: 300px; height: 300px; background: #c084fc; }
        .blob-2 { bottom: -20%; left: -20%; width: 300px; height: 300px; background: #60a5fa; animation-delay: 2s; }
        
        .glass-nav { background: rgba(255,255,255,0.85); backdrop-filter: blur(16px); border-top: 1px solid rgba(255,255,255,0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, createContext, useContext, useRef } = React;

        // --- 1. CONFIGURATION ---
        const THEMES = {
            purple: { name: 'Nebula', bg: 'from-violet-600 via-purple-600 to-indigo-600', text: 'violet' },
            ocean: { name: 'Ocean', bg: 'from-cyan-500 via-blue-600 to-indigo-600', text: 'cyan' },
            sunset: { name: 'Sunset', bg: 'from-orange-500 via-rose-500 to-pink-600', text: 'rose' },
            midnight: { name: 'Midnight', bg: 'from-slate-900 via-purple-900 to-slate-800', text: 'slate' }
        };

        const MISSIONS = [
            { id: 1, title: {en:"First Step", ar:"ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑÿ£ŸàŸÑŸâ"}, desc: {en:"Complete 1 habit", ar:"ÿ£ŸÉŸÖŸÑ ÿπÿßÿØÿ© Ÿàÿßÿ≠ÿØÿ©"}, xp: 50, icon: "üëü" },
            { id: 2, title: {en:"On Fire", ar:"ÿ¥ÿπŸÑÿ© ŸÜÿ¥ÿßÿ∑"}, desc: {en:"Reach 3-day streak", ar:"ÿ≥ŸÑÿ≥ŸÑÿ© 3 ÿ£ŸäÿßŸÖ"}, xp: 100, icon: "üî•" },
            { id: 3, title: {en:"Socialite", ar:"ÿßÿ¨ÿ™ŸÖÿßÿπŸä"}, desc: {en:"Add a friend", ar:"ÿ£ÿ∂ŸÅ ÿµÿØŸäŸÇ"}, xp: 150, icon: "üë•" },
            { id: 4, title: {en:"Master", ar:"ŸÖÿ≠ÿ™ÿ±ŸÅ"}, desc: {en:"Reach Level 5", ar:"ŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ 5"}, xp: 500, icon: "üëë" }
        ];

        // --- 2. ENGINES ---
        const APP_VERSION = '5.0'; // Increment to force data reset if structure breaks
        const storage = {
            get: (key, def) => { 
                try { 
                    if(localStorage.getItem('version') !== APP_VERSION) return def; 
                    return JSON.parse(localStorage.getItem(key)) || def; 
                } catch { return def; } 
            },
            set: (key, val) => { 
                try { 
                    localStorage.setItem(key, JSON.stringify(val)); 
                    localStorage.setItem('version', APP_VERSION);
                } catch {} 
            }
        };

        const SoundEngine = {
            play: (type) => {
                try {
                    const AudioCtor = window.AudioContext || window.webkitAudioContext;
                    if (!AudioCtor) return;
                    const ctx = new AudioCtor();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    const now = ctx.currentTime;
                    
                    if (type === 'success') { // High Ding
                        osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                        gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                        osc.start(now); osc.stop(now + 0.5);
                    } else if (type === 'level') { // Chord
                        [440, 554, 659].forEach((f,i) => {
                            const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination);
                            o.type='triangle'; o.frequency.setValueAtTime(f, now+i*0.1); 
                            g.gain.setValueAtTime(0.2, now+i*0.1); g.gain.exponentialRampToValueAtTime(0.01, now+1.5);
                            o.start(now+i*0.1); o.stop(now+1.5);
                        });
                    } else { // Click
                        osc.frequency.setValueAtTime(300, now); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                        osc.start(now); osc.stop(now + 0.05);
                    }
                } catch(e) {}
            }
        };

        const triggerHaptic = (type) => {
            if (navigator.vibrate) navigator.vibrate(type === 'success' ? [10, 30, 10] : 5);
            SoundEngine.play(type);
        };

        const translations = {
            en: {
                welcome: "Welcome back", today: "Today's Focus", habits: "Habits", 
                new: "New", create: "Create", friends: "Friends", add: "Add", 
                copy: "Copy ID", noHabits: "No habits yet. Start small!", aiCoach: "AI Coach", 
                levelUp: "LEVEL UP!", level: "Lv.", xp: "XP", analytics: "Analytics", 
                settings: "Settings", missions: "Missions", themes: "Themes", 
                data: "Data", reset: "Reset App", unlock: "Unlock Pro", 
                proDesc: "Unlock unlimited habits, themes & analytics.",
                cancel: "Cancel anytime", upgrade: "Upgrade", free: "Free Plan",
                water: "Hydration Check üíß"
            },
            ar: {
                welcome: "ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ÿπŸàÿØÿ™ŸÉ", today: "ÿ™ÿ±ŸÉŸäÿ≤ ÿßŸÑŸäŸàŸÖ", habits: "ÿßŸÑÿπÿßÿØÿßÿ™", 
                new: "ÿ¨ÿØŸäÿØ", create: "ÿ•ŸÜÿ¥ÿßÿ°", friends: "ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°", add: "ÿ•ÿ∂ÿßŸÅÿ©", 
                copy: "ŸÜÿ≥ÿÆ", noHabits: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπÿßÿØÿßÿ™. ÿßÿ®ÿØÿ£ ÿßŸÑÿ¢ŸÜ!", aiCoach: "ÿßŸÑŸÖÿØÿ±ÿ® ÿßŸÑÿ∞ŸÉŸä", 
                levelUp: "ŸÖÿ≥ÿ™ŸàŸâ ÿ¨ÿØŸäÿØ!", level: "ŸÖÿ≥ÿ™ŸàŸâ", xp: "ŸÜŸÇÿßÿ∑", analytics: "ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™", 
                settings: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™", missions: "ÿßŸÑŸÖŸáÿßŸÖ", themes: "ÿßŸÑÿ≥ŸÖÿßÿ™", 
                data: "ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™", reset: "ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ", unlock: "ÿ™ŸÅÿπŸäŸÑ ÿ®ÿ±Ÿà", 
                proDesc: "ÿßŸÅÿ™ÿ≠ ŸÉŸÑ ÿßŸÑÿπÿßÿØÿßÿ™ ŸàÿßŸÑÿ≥ŸÖÿßÿ™ ŸàÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™.",
                cancel: "ÿ•ŸÑÿ∫ÿßÿ° ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™", upgrade: "ÿ™ÿ±ŸÇŸäÿ©", free: "ÿÆÿ∑ÿ© ŸÖÿ¨ÿßŸÜŸäÿ©",
                water: "ÿ™ÿ∞ŸÉŸäÿ± ÿ¥ÿ±ÿ® ÿßŸÑŸÖÿßÿ° üíß"
            }
        };

        // --- 3. COMPONENTS ---
        const Confetti = ({ active }) => {
            if (!active) return null;
            return <div className="fixed inset-0 pointer-events-none z-50">{[...Array(50)].map((_, i) => <div key={i} className="confetti" style={{left: Math.random()*100+'%', background: ['#8b5cf6', '#f472b6', '#34d399'][Math.floor(Math.random()*3)], animation: `confetti ${2+Math.random()}s linear`}} />)}</div>;
        };

        const Card3D = ({ children, onClick, className = "" }) => {
            const ref = useRef(null);
            const handleMove = (e) => {
                if(!ref.current || window.innerWidth < 768) return;
                const rect = ref.current.getBoundingClientRect();
                const x = (e.clientX - rect.left - rect.width/2) / 20;
                const y = (e.clientY - rect.top - rect.height/2) / -20;
                ref.current.style.transform = `perspective(1000px) rotateX(${y}deg) rotateY(${x}deg)`;
            };
            return (
                <div className="card-3d-wrapper py-2">
                    <div ref={ref} className={`card-3d relative overflow-hidden rounded-3xl cursor-pointer ${className}`} 
                         onMouseMove={handleMove} onMouseLeave={(e) => e.currentTarget.style.transform = 'none'} onClick={onClick}>
                        {children}
                    </div>
                </div>
            );
        };

        // --- 4. MAIN APP LOGIC ---
        function App() {
            // State
            const [lang, setLang] = useState(() => storage.get('lang', 'en'));
            const [user, setUser] = useState(() => storage.get('user', { 
                id: 'MOM'+Math.floor(Math.random()*10000), name: 'Champion', avatar: 'ü¶Å', level: 1, xp: 0, theme: 'purple', isPro: false 
            }));
            const [habits, setHabits] = useState(() => storage.get('habits', []));
            const [friends, setFriends] = useState(() => storage.get('friends', []));
            const [activeTab, setActiveTab] = useState('habits');
            const [modal, setModal] = useState(null); // 'add', 'friends', 'paywall', 'levelup'
            const [showConfetti, setShowConfetti] = useState(false);

            const t = translations[lang];
            const isRTL = lang === 'ar';
            const theme = THEMES[user.theme] || THEMES.purple;

            // Persistence
            useEffect(() => { 
                storage.set('lang', lang); storage.set('user', user); storage.set('habits', habits); storage.set('friends', friends);
            }, [lang, user, habits, friends]);

            // Logic
            const today = new Date().toISOString().split('T')[0];
            const progress = habits.length ? Math.round((habits.filter(h => (h.done?.[today]||0) >= h.goal).length / habits.length) * 100) : 0;
            const aiMsg = progress === 100 ? "Perfect!" : progress > 50 ? "Keep going!" : "Start small.";

            // Actions
            const addHabit = (name) => {
                if(!name) return;
                if(!user.isPro && habits.length >= 3) { setModal('paywall'); return; }
                setHabits([...habits, { id: Date.now(), name, goal: 1, done: {}, emoji: '‚ö°', streak: 0 }]);
                setModal(null); triggerHaptic('success');
            };

            const toggleHabit = (id) => {
                triggerHaptic('success');
                setHabits(habits.map(h => {
                    if(h.id === id) {
                        const val = (h.done[today] || 0) + 1;
                        if(val >= h.goal) {
                            // XP & Level Up Logic
                            let nextXp = user.xp + 25;
                            if(nextXp >= user.level * 100) {
                                setUser(u => ({...u, xp: 0, level: u.level + 1}));
                                setModal('levelup'); SoundEngine.play('level');
                            } else {
                                setUser(u => ({...u, xp: nextXp}));
                            }
                            setShowConfetti(true); setTimeout(() => setShowConfetti(false), 2000); 
                        }
                        return { ...h, done: { ...h.done, [today]: val }, streak: val >= h.goal ? h.streak + 1 : h.streak };
                    }
                    return h;
                }));
            };

            const addFriend = (id) => {
                if(!id || id === user.id || friends.find(f => f.id === id)) return;
                // Deterministic Friend Generator
                const names = ['Alex', 'Jordan', 'Taylor', 'Casey', 'Riley'];
                const avatars = ['ü¶ä', 'üêØ', 'üê∏', 'üê®', 'ü¶Ñ'];
                const seed = id.charCodeAt(id.length-1);
                setFriends([...friends, { id, name: names[seed % names.length], avatar: avatars[seed % avatars.length], level: (seed % 10) + 1 }]);
                triggerHaptic('success');
            };

            // Analytics Data
            const getChartData = () => {
                return Array.from({length:7}, (_, i) => {
                    const d = new Date(); d.setDate(d.getDate() - (6-i));
                    const dateStr = d.toISOString().split('T')[0];
                    const total = habits.length;
                    const done = habits.filter(h => (h.done?.[dateStr]||0) >= h.goal).length;
                    return total ? (done/total)*100 : 0;
                });
            };

            return (
                <div dir={isRTL ? 'rtl' : 'ltr'} className="min-h-screen pb-32 text-slate-800 relative select-none">
                    <Confetti active={showConfetti} />
                    <div className="blob blob-1"></div><div className="blob blob-2"></div>

                    {/* --- HEADER --- */}
                    <header className="px-6 pt-12 pb-4 sticky top-0 z-30 bg-white/80 backdrop-blur-md transition-all border-b border-white/50">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-4">
                                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-3xl shadow-lg bg-gradient-to-br ${theme.bg} text-white`}>{user.avatar}</div>
                                <div>
                                    <h1 className="text-xs font-bold text-gray-400 uppercase tracking-widest">{t.welcome}</h1>
                                    <h2 className="text-2xl font-black">{user.name}</h2>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>{triggerHaptic('click'); setLang(lang==='en'?'ar':'en')}} className="w-10 h-10 rounded-xl bg-white shadow-sm flex items-center justify-center text-xl">{lang==='en'?'üá∏üá¶':'üá∫üá∏'}</button>
                                <button onClick={()=>{triggerHaptic('click'); setModal('friends')}} className="w-10 h-10 rounded-xl bg-white shadow-sm flex items-center justify-center text-xl relative">
                                    üë• {friends.length > 0 && <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>}
                                </button>
                            </div>
                        </div>
                        {/* XP Bar */}
                        <div className="mb-2 px-1">
                            <div className="flex justify-between text-xs font-bold text-gray-500 mb-1"><span>{t.xp} {user.xp}/{user.level*100}</span><span>{t.level} {user.level+1}</span></div>
                            <div className="w-full bg-gray-200 h-2 rounded-full overflow-hidden"><div className={`h-full transition-all duration-500 bg-gradient-to-r ${theme.bg}`} style={{width: `${(user.xp/(user.level*100))*100}%`}}></div></div>
                        </div>
                    </header>

                    {/* --- MAIN CONTENT --- */}
                    <main className="px-6 space-y-6 mt-6 animate-slide">
                        
                        {/* HABITS TAB */}
                        {activeTab === 'habits' && (
                            <>
                                <Card3D className={`bg-gradient-to-br ${theme.bg} text-white p-6`}>
                                    <div className="flex justify-between items-center mb-6">
                                        <div><p className="text-white/80 font-bold text-xs uppercase">{t.today}</p><h3 className="text-4xl font-black">{progress}%</h3></div>
                                        <div className="text-4xl">üî•</div>
                                    </div>
                                    <div className="w-full bg-black/20 h-3 rounded-full overflow-hidden"><div className="h-full bg-white transition-all duration-1000" style={{width: `${progress}%`}} /></div>
                                </Card3D>

                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-xl">{t.habits}</h3>
                                        <button onClick={()=>{triggerHaptic('click'); setModal('add')}} className={`text-${theme.text}-600 font-bold text-sm bg-white px-4 py-2 rounded-full shadow-sm`}>+ {t.new}</button>
                                    </div>
                                    <div className="space-y-4">
                                        {habits.map(h => {
                                            const done = (h.done[today]||0) >= h.goal;
                                            return (
                                                <Card3D key={h.id} onClick={() => toggleHabit(h.id)} className={`p-4 flex items-center gap-4 ${done ? 'opacity-60' : ''}`}>
                                                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-inner ${done ? 'bg-green-400 text-white' : 'bg-white'}`}>{done ? '‚úì' : h.emoji}</div>
                                                    <div className="flex-1"><h4 className={`font-bold text-lg ${done && 'line-through'}`}>{h.name}</h4><div className="text-xs font-bold text-orange-500">üî• {h.streak}</div></div>
                                                </Card3D>
                                            )
                                        })}
                                        {habits.length === 0 && <div className="text-center py-12 opacity-50"><div className="text-5xl mb-4">üå±</div><p>{t.noHabits}</p></div>}
                                    </div>
                                </div>
                            </>
                        )}

                        {/* MISSIONS TAB */}
                        {activeTab === 'missions' && (
                            <div className="space-y-4">
                                <h2 className="text-2xl font-black text-slate-800">{t.missions}</h2>
                                {MISSIONS.map(m => (
                                    <div key={m.id} className="bg-white p-4 rounded-3xl shadow-sm border border-white/50 flex items-center gap-4">
                                        <div className="text-3xl">{m.icon}</div>
                                        <div className="flex-1">
                                            <h4 className="font-bold text-slate-800">{m.title[lang]}</h4>
                                            <p className="text-xs text-slate-500">{m.desc[lang]}</p>
                                        </div>
                                        <div className={`px-3 py-1 bg-${theme.text}-100 text-${theme.text}-600 rounded-lg text-xs font-bold`}>+{m.xp} XP</div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* ANALYTICS TAB */}
                        {activeTab === 'analytics' && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-black text-slate-800">{t.analytics}</h2>
                                <Card3D className="p-6 bg-white">
                                    <div className="flex items-end justify-between h-32 gap-2">
                                        {getChartData().map((pct, i) => (
                                            <div key={i} className="flex-1 bg-slate-100 rounded-t-lg relative overflow-hidden">
                                                <div className={`absolute bottom-0 w-full transition-all duration-1000 bg-${theme.text}-500`} style={{height: `${Math.max(5, pct)}%`}}></div>
                                            </div>
                                        ))}
                                    </div>
                                    <p className="text-center text-xs font-bold text-slate-400 mt-4 uppercase">Last 7 Days</p>
                                </Card3D>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-4 rounded-3xl shadow-sm text-center"><p className={`text-3xl font-black text-${theme.text}-600`}>{Math.max(...habits.map(h=>h.streak), 0)}</p><p className="text-xs text-slate-400 font-bold uppercase">Best Streak</p></div>
                                    <div className="bg-white p-4 rounded-3xl shadow-sm text-center"><p className="text-3xl font-black text-slate-800">{user.level}</p><p className="text-xs text-slate-400 font-bold uppercase">{t.level}</p></div>
                                </div>
                            </div>
                        )}

                        {/* SETTINGS TAB */}
                        {activeTab === 'settings' && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-black text-slate-800">{t.settings}</h2>
                                
                                {/* Theme Switcher */}
                                <div className="bg-white p-6 rounded-3xl shadow-sm">
                                    <h3 className="font-bold mb-4 text-xs uppercase text-gray-400">{t.themes}</h3>
                                    <div className="flex gap-3 overflow-x-auto pb-2">
                                        {Object.entries(THEMES).map(([key, th]) => (
                                            <button key={key} onClick={()=>{
                                                if(key!=='purple' && !user.isPro) { setModal('paywall'); return; }
                                                setUser({...user, theme: key}); triggerHaptic('click');
                                            }} className={`w-12 h-12 rounded-full bg-gradient-to-br ${th.bg} flex-shrink-0 border-2 ${user.theme===key ? 'border-black' : 'border-transparent'} relative`}>
                                                {!user.isPro && key!=='purple' && <span className="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full text-white text-xs">üîí</span>}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Pro Status */}
                                <div className="bg-slate-900 text-white p-6 rounded-3xl shadow-lg relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                                    <h3 className="font-bold text-xl mb-1">{user.isPro ? "MAX Active" : "Free Plan"}</h3>
                                    <p className="text-slate-400 text-sm mb-4">{user.isPro ? "You are a legend." : t.proDesc}</p>
                                    {!user.isPro && <button onClick={()=>setModal('paywall')} className="bg-white text-black px-6 py-2 rounded-xl font-bold text-sm">{t.upgrade}</button>}
                                </div>

                                <button onClick={()=>{if(confirm('Reset?')) {localStorage.clear(); window.location.reload()}}} className="w-full py-4 text-red-500 font-bold bg-red-50 rounded-2xl">{t.reset}</button>
                            </div>
                        )}
                    </main>

                    {/* --- NAVIGATION --- */}
                    <nav className="fixed bottom-8 left-6 right-6 glass-nav rounded-3xl p-2 shadow-2xl flex justify-between z-40">
                        {[
                            {id: 'habits', icon: 'üéØ'},
                            {id: 'missions', icon: 'üèÜ'},
                            {id: 'analytics', icon: 'üìä'},
                            {id: 'settings', icon: '‚öôÔ∏è'}
                        ].map(item => (
                            <button key={item.id} onClick={() => {triggerHaptic('click'); setActiveTab(item.id)}} 
                                className={`flex-1 py-4 rounded-2xl text-2xl transition-all ${activeTab===item.id ? 'bg-slate-900 text-white shadow-xl -translate-y-4 scale-110' : 'text-slate-400'}`}>
                                {item.icon}
                            </button>
                        ))}
                    </nav>

                    {/* --- MODALS --- */}
                    
                    {/* 1. Add Habit */}
                    {modal === 'add' && (
                        <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end justify-center" onClick={()=>setModal(null)}>
                            <div className="bg-white w-full max-w-md rounded-t-[32px] p-8 animate-slide" onClick={e=>e.stopPropagation()}>
                                <h2 className="text-2xl font-black mb-6">{t.new}</h2>
                                <input id="inp" placeholder="e.g. Read Books" className="w-full p-4 bg-slate-100 rounded-2xl mb-4 font-bold outline-none" autoFocus />
                                <button onClick={()=>addHabit(document.getElementById('inp').value)} className={`w-full py-4 rounded-2xl font-bold text-white bg-gradient-to-r ${theme.bg}`}>{t.create}</button>
                            </div>
                        </div>
                    )}

                    {/* 2. Friends */}
                    {modal === 'friends' && (
                        <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-md flex items-center justify-center p-4" onClick={()=>setModal(null)}>
                            <div className="bg-white w-full max-w-md rounded-[32px] p-6 h-[60vh] flex flex-col animate-pop" onClick={e=>e.stopPropagation()}>
                                <div className="bg-slate-900 text-white p-6 rounded-3xl mb-6 flex justify-between items-center">
                                    <code className="text-2xl font-mono font-bold">{user.id}</code>
                                    <button onClick={()=>{navigator.clipboard.writeText(user.id); triggerHaptic('success')}} className="bg-white/20 px-3 py-1 rounded-lg text-xs">{t.copy}</button>
                                </div>
                                <div className="flex gap-2 mb-4">
                                    <input id="fid" placeholder="ID" className="flex-1 p-3 bg-slate-100 rounded-xl font-bold" />
                                    <button onClick={()=>addFriend(document.getElementById('fid').value)} className={`bg-gradient-to-r ${theme.bg} text-white px-6 rounded-xl font-bold`}>+</button>
                                </div>
                                <div className="overflow-y-auto flex-1 space-y-2">
                                    {friends.map(f => (
                                        <div key={f.id} className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                                            <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm">{f.avatar}</div>
                                            <div className="flex-1"><h4 className="font-bold">{f.name}</h4><p className="text-xs text-orange-500">Lv.{f.level}</p></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 3. Paywall */}
                    {modal === 'paywall' && (
                        <div className="fixed inset-0 z-50 bg-black/70 backdrop-blur-md flex items-center justify-center p-6 animate-pop">
                            <div className="bg-white w-full max-w-sm rounded-[32px] p-8 text-center relative overflow-hidden">
                                <div className={`absolute top-0 left-0 w-full h-2 bg-gradient-to-r ${theme.bg}`} />
                                <div className="text-6xl mb-4 animate-float">üíé</div>
                                <h2 className="text-3xl font-black text-slate-900 mb-2">{t.upgrade}</h2>
                                <p className="text-slate-500 mb-6">{t.proDesc}</p>
                                <button onClick={()=>{setUser({...user, isPro:true}); setModal(null); triggerHaptic('success'); setShowConfetti(true); setTimeout(()=>setShowConfetti(false), 2000)}} 
                                    className={`w-full py-4 rounded-xl font-bold text-white bg-gradient-to-r ${theme.bg} shadow-lg`}>Unlock Free (Demo)</button>
                                <p className="text-xs text-slate-300 mt-4">{t.cancel}</p>
                            </div>
                        </div>
                    )}

                    {/* 4. Level Up */}
                    {modal === 'levelup' && (
                        <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-pop">
                            <div className="bg-white w-full max-w-sm rounded-[32px] p-8 text-center relative overflow-hidden">
                                <div className="text-8xl mb-4 animate-float">üéâ</div>
                                <h2 className="text-3xl font-black text-slate-800 mb-2">{t.levelUp}</h2>
                                <p className="text-slate-500 mb-6 font-bold">{t.level} {user.level}</p>
                                <button onClick={()=>setModal(null)} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-xl">{t.continue}</button>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
