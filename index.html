<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Momentum MAX | Enterprise Edition</title>

    <script>
        window.onerror = function(msg, url, line) {
            document.body.innerHTML = `<div style="background:#000;color:#ef4444;height:100vh;padding:2rem;font-family:monospace;display:flex;flex-direction:column;justify-content:center;text-align:center;"><h1 style="font-size:2rem;margin-bottom:1rem">SYSTEM KERNEL PANIC</h1><p style="opacity:0.7">${msg}</p><div style="background:#222;padding:1rem;margin:1rem 0;border-radius:8px">Line: ${line}</div><button onclick="localStorage.clear();window.location.reload()" style="background:#ef4444;color:white;border:none;padding:1rem;border-radius:8px;font-weight:bold;margin-top:2rem">HARD RESET DATABASE</button></div>`;
        };
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           ATLAS DESIGN SYSTEM v2.0 (Dashboard Upgrades)
           ========================================= */
        :root {
            --bg-main: #020617;
            --primary: #6366f1;
            --accent: #ec4899;
            --glass: rgba(30, 41, 59, 0.7);
            --border: rgba(255, 255, 255, 0.08);
            --ease: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        * { font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; box-sizing: border-box; touch-action: manipulation; user-select: none; }
        [dir="rtl"] * { font-family: 'Tajawal', sans-serif; }
        
        body { background-color: var(--bg-main); color: #fff; overflow: hidden; width: 100vw; height: 100vh; perspective: 1000px; }

        /* 3D ENGINE */
        .card-3d {
            position: relative;
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6);
            transform-style: preserve-3d;
            transition: transform 0.1s linear, box-shadow 0.3s;
        }
        .card-3d:active { transform: scale(0.96) rotateX(2deg); }

        /* HERO LIQUID FILL */
        .liquid-fill {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, var(--primary), #a855f7);
            transition: height 1s var(--ease);
            opacity: 0.2; border-radius: inherit;
        }

        /* CALENDAR STRIP */
        .date-card {
            min-width: 60px; height: 80px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 20px; background: rgba(255,255,255,0.03);
            border: 1px solid transparent; transition: all 0.3s var(--ease);
        }
        .date-card.active {
            background: var(--primary);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.5);
            transform: translateY(-5px) scale(1.1);
            border-color: rgba(255,255,255,0.5);
        }

        /* ANIMATIONS */
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        @keyframes pop { 0%{transform:scale(0.8);opacity:0} 100%{transform:scale(1);opacity:1} }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .animate-float { animation: float 6s ease-in-out infinite; }
        .animate-pop { animation: pop 0.4s var(--ease) forwards; }
        .animate-slide-up { animation: slideUp 0.5s var(--ease) forwards; }

        /* UI UTILS */
        .btn-primary { background: linear-gradient(135deg, var(--primary), #8b5cf6); box-shadow: 0 8px 32px -8px rgba(99,102,241,0.5); }
        .blob-bg { position: fixed; filter: blur(120px); z-index: -1; opacity: 0.3; border-radius: 50%; animation: float 10s infinite; }
        .scroll-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef, useReducer } = React;

        // =========================================
        // 1. ASSET LIBRARY
        // =========================================
        const Icons = {
            bolt: <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            check: <path d="M20 6L9 17l-5-5" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>,
            plus: <path d="M12 5v14M5 12h14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            home: <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            chart: <path d="M18 20V10M12 20V4M6 20v-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            user: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            calendar: <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" strokeWidth="2"/><line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" strokeWidth="2"/><line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" strokeWidth="2"/>,
            fire: <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a7 7 0 0 0 .9 2.8z" stroke="currentColor" strokeWidth="2"/>,
            star: <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" strokeWidth="2"/>
        };

        const Icon = ({ name, size=24, className="" }) => <svg viewBox="0 0 24 24" width={size} height={size} fill="none" className={className}>{Icons[name]||Icons.bolt}</svg>;

        // =========================================
        // 2. ENGINES (Audio, Storage, Reducer)
        // =========================================
        const Sfx = {
            play: (type) => {
                if(!window.AudioContext && !window.webkitAudioContext) return;
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator(); const g = ctx.createGain();
                osc.connect(g); g.connect(ctx.destination);
                const t = ctx.currentTime;
                
                if (type === 'tap') {
                    osc.frequency.setValueAtTime(400, t); osc.frequency.exponentialRampToValueAtTime(600, t+0.05);
                    g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.05);
                    osc.start(t); osc.stop(t+0.05);
                } else if (type === 'success') {
                    [523, 659, 783].forEach((f,i) => {
                        const o=ctx.createOscillator(); const gx=ctx.createGain();
                        o.connect(gx); gx.connect(ctx.destination);
                        o.frequency.value=f; gx.gain.setValueAtTime(0.05, t+i*0.05);
                        gx.gain.linearRampToValueAtTime(0.001, t+i*0.05+0.4);
                        o.start(t+i*0.05); o.stop(t+i*0.05+0.4);
                    });
                }
            }
        };

        const Storage = {
            load: () => { try { return JSON.parse(localStorage.getItem('MAX_V2')) || null } catch { return null } },
            save: (state) => localStorage.setItem('MAX_V2', JSON.stringify(state))
        };

        const reducer = (state, action) => {
            const next = { ...state };
            switch(action.type) {
                case 'SET_ONBOARDING': next.onboardingStep = action.payload; break;
                case 'UPDATE_USER': next.user = { ...next.user, ...action.payload }; break;
                case 'ADD_HABIT': next.habits.push(action.payload); break;
                case 'TOGGLE_HABIT':
                    const { id, date } = action.payload;
                    if (!next.logs[date]) next.logs[date] = {};
                    const current = next.logs[date][id] || 0;
                    const habit = next.habits.find(h => h.id === id);
                    if (current < habit.goal) {
                        next.logs[date][id] = current + 1;
                        next.user.xp += 20; // XP Gain
                    }
                    break;
                case 'RESET': return null;
            }
            Storage.save(next);
            return next;
        };

        const INITIAL_STATE = {
            user: { name: '', avatar: 'ðŸ¦', xp: 0, level: 1, isPro: false },
            settings: { lang: 'en', theme: 'midnight' },
            habits: [],
            logs: {},
            onboardingStep: 0
        };

        // =========================================
        // 3. COMPONENTS
        // =========================================
        const Card3D = ({ children, onClick, className="" }) => {
            const ref = useRef(null);
            const handleMove = (e) => {
                if(!ref.current) return;
                const r = ref.current.getBoundingClientRect();
                const x = e.clientX - r.left; const y = e.clientY - r.top;
                ref.current.style.setProperty('--x', x); ref.current.style.setProperty('--y', y);
            };
            return <div ref={ref} onMouseMove={handleMove} onClick={(e)=>{Sfx.play('tap'); onClick&&onClick(e)}} className={`card-3d p-5 rounded-3xl overflow-hidden cursor-pointer ${className}`}>{children}</div>;
        };

        const DateStrip = ({ selected, onSelect }) => {
            const days = useMemo(() => Array.from({length:7}, (_,i) => {
                const d = new Date(); d.setDate(d.getDate() - 3 + i);
                return { date: d.toISOString().split('T')[0], day: d.getDate(), name: d.toLocaleDateString('en-US', {weekday:'short'}) };
            }), []);

            return (
                <div className="flex gap-3 overflow-x-auto pb-4 pt-2 px-2 scroll-hide snap-x">
                    {days.map(d => (
                        <div key={d.date} onClick={() => {Sfx.play('tap'); onSelect(d.date)}} 
                             className={`date-card snap-center flex-shrink-0 cursor-pointer ${selected === d.date ? 'active' : ''}`}>
                            <div className="text-xs font-bold opacity-60 mb-1">{d.name}</div>
                            <div className="text-xl font-black">{d.day}</div>
                        </div>
                    ))}
                </div>
            );
        };

        // =========================================
        // 4. MAIN DASHBOARD (The Core Part 2)
        // =========================================
        const Dashboard = ({ state, dispatch }) => {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [showAdd, setShowAdd] = useState(false);
            const [activeTab, setActiveTab] = useState('home');

            // Stats Logic
            const dailyLogs = state.logs[date] || {};
            const completed = state.habits.filter(h => (dailyLogs[h.id] || 0) >= h.goal).length;
            const total = state.habits.length;
            const progress = total ? Math.round((completed / total) * 100) : 0;

            const handleAddHabit = (name) => {
                if (!name) return;
                dispatch({ 
                    type: 'ADD_HABIT', 
                    payload: { id: Date.now(), name, goal: 1, icon: 'star', color: 'indigo' } 
                });
                setShowAdd(false);
                Sfx.play('success');
            };

            return (
                <div className="h-screen flex flex-col relative">
                    <div className="blob-bg top-0 right-0 w-80 h-80 bg-indigo-600"></div>
                    <div className="blob-bg bottom-0 left-0 w-80 h-80 bg-pink-600"></div>

                    {/* HEADER */}
                    <div className="px-6 pt-12 pb-2 flex justify-between items-center bg-slate-900/50 backdrop-blur-md z-20">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-xl shadow-lg border border-white/20">
                                {state.user.avatar}
                            </div>
                            <div>
                                <div className="text-[10px] font-bold text-indigo-300 uppercase tracking-widest">Welcome Back</div>
                                <div className="text-lg font-black leading-none">{state.user.name}</div>
                            </div>
                        </div>
                        <div className="px-3 py-1 bg-white/10 rounded-full border border-white/10 text-xs font-bold flex items-center gap-2">
                            <span className="text-yellow-400">âš¡</span> {state.user.xp} XP
                        </div>
                    </div>

                    {/* CALENDAR STRIP */}
                    <div className="px-4 mb-2">
                        <DateStrip selected={date} onSelect={setDate} />
                    </div>

                    {/* SCROLLABLE CONTENT */}
                    <div className="flex-1 overflow-y-auto px-6 pb-32 space-y-6 animate-slide-up">
                        
                        {/* HERO CARD */}
                        <Card3D className="h-48 flex flex-col justify-between border-0 relative group">
                            <div className="absolute inset-0 bg-gradient-to-br from-indigo-600 to-purple-700 opacity-90 z-0"></div>
                            {/* Liquid Fill Animation */}
                            <div className="liquid-fill z-0" style={{height: `${progress}%`}}></div>
                            
                            <div className="relative z-10 flex justify-between items-start">
                                <div>
                                    <div className="text-indigo-200 text-xs font-bold uppercase mb-1">Daily Focus</div>
                                    <div className="text-5xl font-black tracking-tight">{progress}%</div>
                                </div>
                                <div className="w-12 h-12 rounded-2xl bg-white/10 backdrop-blur flex items-center justify-center text-2xl border border-white/20">
                                    ðŸ”¥
                                </div>
                            </div>
                            <div className="relative z-10 text-sm font-medium text-indigo-100 opacity-80">
                                {progress === 100 ? "All tasks complete! You're unstoppable." : `${completed} of ${total} habits completed`}
                            </div>
                        </Card3D>

                        {/* HABITS LIST */}
                        <div className="space-y-4">
                            <div className="flex justify-between items-end">
                                <h2 className="text-xl font-bold">Your Habits</h2>
                                <button onClick={()=>setShowAdd(true)} className="text-indigo-400 text-sm font-bold bg-indigo-500/10 px-3 py-1 rounded-lg hover:bg-indigo-500/20 transition">+ New Habit</button>
                            </div>

                            {state.habits.length === 0 ? (
                                <div className="text-center py-10 opacity-50 border-2 border-dashed border-slate-700 rounded-3xl">
                                    <div className="text-4xl mb-4 grayscale">ðŸŒ±</div>
                                    <p>No habits for this day.</p>
                                    <button onClick={()=>setShowAdd(true)} className="mt-4 text-indigo-400 font-bold underline">Create your first habit</button>
                                </div>
                            ) : (
                                state.habits.map(habit => {
                                    const count = dailyLogs[habit.id] || 0;
                                    const isDone = count >= habit.goal;
                                    
                                    return (
                                        <Card key={habit.id} onClick={() => dispatch({type:'TOGGLE_HABIT', payload:{id:habit.id, date}})} 
                                              className={`flex items-center gap-4 transition-all duration-500 ${isDone ? 'opacity-60 grayscale-[0.5] bg-green-900/20 border-green-500/30' : ''}`}>
                                            <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl transition-all duration-300 ${isDone ? 'bg-green-500 text-white scale-110 shadow-[0_0_20px_rgba(34,197,94,0.4)]' : 'bg-slate-700/50 text-indigo-400'}`}>
                                                {isDone ? <Icon name="check" /> : <Icon name={habit.icon || 'star'} />}
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex justify-between mb-2">
                                                    <span className={`font-bold text-lg ${isDone && 'line-through text-slate-400'}`}>{habit.name}</span>
                                                    <span className="text-xs font-bold text-slate-500">{count}/{habit.goal}</span>
                                                </div>
                                                <div className="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                                                    <div className={`h-full transition-all duration-700 ${isDone ? 'bg-green-500' : 'bg-indigo-500'}`} style={{width: `${(count/habit.goal)*100}%`}}></div>
                                                </div>
                                            </div>
                                        </Card>
                                    );
                                })
                            )}
                        </div>
                    </div>

                    {/* NAVIGATION BAR */}
                    <div className="fixed bottom-6 left-6 right-6 h-20 bg-slate-900/90 backdrop-blur-xl rounded-3xl border border-white/10 shadow-2xl flex justify-around items-center px-2 z-50">
                        {['home', 'chart', 'user'].map(tab => (
                            <button key={tab} onClick={() => {Sfx.play('tap'); setActiveTab(tab)}} 
                                className={`p-4 rounded-2xl transition-all duration-300 ${activeTab === tab ? 'bg-indigo-600 text-white shadow-[0_10px_20px_-5px_rgba(79,70,229,0.5)] -translate-y-4 scale-110' : 'text-slate-500 hover:text-white'}`}>
                                <Icon name={tab} size={24} />
                            </button>
                        ))}
                    </div>

                    {/* ADD HABIT MODAL */}
                    {showAdd && (
                        <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end justify-center animate-pop" onClick={()=>setShowAdd(false)}>
                            <div className="bg-slate-900 w-full max-w-md rounded-t-[40px] p-8 border-t border-white/10" onClick={e=>e.stopPropagation()}>
                                <div className="w-12 h-1.5 bg-slate-700 rounded-full mx-auto mb-8"></div>
                                <h2 className="text-3xl font-black mb-6">New Habit</h2>
                                <input id="newHabit" placeholder="e.g., Drink Water" className="w-full bg-slate-800 p-5 rounded-2xl text-xl font-bold text-white placeholder:text-slate-600 outline-none focus:ring-2 focus:ring-indigo-500 mb-6 border border-white/5" autoFocus />
                                <div className="flex gap-3">
                                    <button onClick={()=>setShowAdd(false)} className="flex-1 py-4 font-bold text-slate-400">Cancel</button>
                                    <button onClick={()=>handleAddHabit(document.getElementById('newHabit').value)} className="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg">Create Habit</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =========================================
        // 5. ONBOARDING (Simplified for Context)
        // =========================================
        const Onboarding = ({ dispatch }) => {
            const [step, setStep] = useState(0);
            const [name, setName] = useState("");
            
            const next = () => { Sfx.play('tap'); setStep(s => s + 1); };
            const finish = () => {
                Sfx.play('success');
                dispatch({ type: 'UPDATE_USER', payload: { name } });
                dispatch({ type: 'SET_ONBOARDING', payload: 5 });
            };

            if(step === 0) return <div className="h-screen flex flex-col items-center justify-center p-8 text-center animate-pop"><div className="text-6xl mb-6">ðŸš€</div><h1 className="text-4xl font-black mb-4">Momentum</h1><p className="text-slate-400 mb-8">The ultimate habit tracker.</p><button onClick={next} className="btn-primary w-full py-4 rounded-2xl font-bold text-white shadow-lg">Get Started</button></div>;
            
            if(step === 1) return <div className="h-screen flex flex-col justify-center p-8 animate-slide-up"><h2 className="text-3xl font-bold mb-4">What's your name?</h2><input value={name} onChange={e=>setName(e.target.value)} placeholder="Name" className="bg-transparent border-b-2 border-slate-700 text-3xl font-bold py-2 mb-8 focus:outline-none focus:border-indigo-500" /><button onClick={finish} disabled={!name} className="btn-primary w-full py-4 rounded-2xl font-bold text-white shadow-lg disabled:opacity-50">Start Dashboard</button></div>;
        };

        // =========================================
        // 6. ROOT APP
        // =========================================
        function App() {
            const [state, dispatch] = useReducer(reducer, Storage.load() || INITIAL_STATE);
            
            // If onboarding not done (step < 5)
            if (state.onboardingStep < 5) return <Onboarding dispatch={dispatch} />;
            
            // Otherwise, Dashboard
            return <Dashboard state={state} dispatch={dispatch} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
