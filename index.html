<script type="text/babel">
        const { useState, useEffect, useCallback, createContext, useContext, useRef } = React;

        // --- 1. AUDIO ENGINE (Synthesized Sounds - No Downloads Needed) ---
        const SoundEngine = {
            ctx: null,
            init: () => {
                if (!SoundEngine.ctx) {
                    SoundEngine.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            play: (type) => {
                SoundEngine.init();
                const ctx = SoundEngine.ctx;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);

                const now = ctx.currentTime;
                
                if (type === 'success') {
                    // Satisfying "Ding" (Sine wave, high pitch)
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(500, now);
                    osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now);
                    osc.stop(now + 0.5);
                } else if (type === 'levelup') {
                    // Celebration Chord
                    [440, 554, 659].forEach((freq, i) => {
                        const osc2 = ctx.createOscillator();
                        const gain2 = ctx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(ctx.destination);
                        osc2.type = 'triangle';
                        osc2.frequency.setValueAtTime(freq, now + (i*0.1));
                        gain2.gain.setValueAtTime(0.2, now + (i*0.1));
                        gain2.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
                        osc2.start(now + (i*0.1));
                        osc2.stop(now + 1.5);
                    });
                } else if (type === 'click') {
                    // Soft Click
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(300, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                }
            }
        };

        // --- DATA & CONFIG ---
        const translations = {
            en: {
                appName: "Momentum MAX", welcome: "Good Morning", today: "Today's Focus", 
                habits: "Habits", newHabit: "New Habit", create: "Create", 
                upgrade: "Upgrade to Pro", unlock: "Unlock full potential", 
                friends: "Friends", add: "Add Friend", yourId: "Your ID", 
                copy: "Copy", freeHabits: "No habits yet. Start now!",
                aiCoach: "AI Coach", water: "Hydration Check ðŸ’§",
                levelUp: "LEVEL UP!", level: "Level", continue: "Continue",
                xp: "XP"
            },
            ar: {
                appName: "Ù…ÙˆÙ…Ù†ØªÙ… Ù…Ø§ÙƒØ³", welcome: "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±", today: "ØªØ±ÙƒÙŠØ² Ø§Ù„ÙŠÙˆÙ…",
                habits: "Ø§Ù„Ø¹Ø§Ø¯Ø§Øª", newHabit: "Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©", create: "Ø¥Ù†Ø´Ø§Ø¡",
                upgrade: "ØªØ±Ù‚ÙŠØ© Ù„Ø¨Ø±Ùˆ", unlock: "Ø£Ø·Ù„Ù‚ Ù‚Ø¯Ø±Ø§ØªÙƒ",
                friends: "Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡", add: "Ø¥Ø¶Ø§ÙØ©", yourId: "Ù…Ø¹Ø±ÙÙƒ",
                copy: "Ù†Ø³Ø®", freeHabits: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø§Ø¯Ø§Øª. Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†!",
                aiCoach: "Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø°ÙƒÙŠ", water: "ØªØ°ÙƒÙŠØ± Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡ ðŸ’§",
                levelUp: "Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯!", level: "Ù…Ø³ØªÙˆÙ‰", continue: "Ù…ØªØ§Ø¨Ø¹Ø©",
                xp: "Ù†Ù‚Ø§Ø·"
            }
        };

        const LanguageContext = createContext();

        // --- HELPERS ---
        const storage = {
            get: (key, def) => { try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; } },
            set: (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }
        };

        const triggerHaptic = (type) => {
            if (typeof navigator !== 'undefined' && navigator.vibrate) navigator.vibrate(type === 'success' ? [10, 30, 10] : 10);
            SoundEngine.play(type === 'success' ? 'success' : 'click'); // Integrate Sound here
        };

        // --- COMPONENTS ---
        const Confetti = ({ active }) => {
            if (!active) return null;
            return <div className="fixed inset-0 pointer-events-none z-50">{[...Array(40)].map((_, i) => <div key={i} className="confetti" style={{left: Math.random()*100+'%', background: ['#8b5cf6', '#f472b6', '#34d399'][Math.floor(Math.random()*3)], animation: `confetti ${2+Math.random()}s linear`}} />)}</div>;
        };

        const Card3D = ({ children, onClick, className = "" }) => {
            const ref = useRef(null);
            const handleMove = (e) => {
                if(!ref.current || window.innerWidth < 768) return;
                const rect = ref.current.getBoundingClientRect();
                const x = (e.clientX - rect.left - rect.width/2) / 20;
                const y = (e.clientY - rect.top - rect.height/2) / -20;
                ref.current.style.transform = `perspective(1000px) rotateX(${y}deg) rotateY(${x}deg)`;
            };
            return (
                <div className="card-3d-wrapper py-2">
                    <div ref={ref} className={`card-3d relative overflow-hidden rounded-3xl cursor-pointer ${className}`} 
                         onMouseMove={handleMove} onMouseLeave={(e) => e.currentTarget.style.transform = 'none'} onClick={onClick}>
                        {children}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [lang, setLang] = useState(() => storage.get('lang', 'en'));
            const t = translations[lang];
            const isRTL = lang === 'ar';
            
            const [user, setUser] = useState(() => storage.get('user', { 
                id: 'MOM'+Math.floor(Math.random()*10000), name: 'Champion', avatar: 'ðŸ¦', level: 1, xp: 0, maxXp: 100 
            }));
            const [habits, setHabits] = useState(() => storage.get('habits', []));
            const [friends, setFriends] = useState(() => storage.get('friends', []));
            const [showConfetti, setShowConfetti] = useState(false);
            const [activeTab, setActiveTab] = useState('habits');
            const [modal, setModal] = useState(null); // 'paywall', 'addHabit', 'friends', 'levelUp'

            useEffect(() => { storage.set('habits', habits); storage.set('user', user); storage.set('friends', friends); storage.set('lang', lang); }, [habits, user, friends, lang]);

            // Logic
            const today = new Date().toISOString().split('T')[0];
            const progress = habits.length ? Math.round((habits.filter(h => (h.done?.[today]||0) >= h.goal).length / habits.length) * 100) : 0;
            const aiMsg = progress === 100 ? "Perfect Day!" : progress > 50 ? "Keep Pushing!" : "Start Small.";

            const addHabit = (name) => {
                if(!name) return;
                setHabits([...habits, { id: Date.now(), name, goal: 1, done: {}, emoji: 'âš¡', streak: 0 }]);
                setModal(null); triggerHaptic('success');
            };

            const checkLevelUp = (currentXp, currentLevel) => {
                const requiredXp = currentLevel * 100;
                if (currentXp >= requiredXp) {
                    const leftoverXp = currentXp - requiredXp;
                    setUser(u => ({ ...u, xp: leftoverXp, level: u.level + 1, maxXp: (u.level + 1) * 100 }));
                    setModal('levelUp');
                    SoundEngine.play('levelup');
                    setShowConfetti(true);
                    setTimeout(() => setShowConfetti(false), 4000);
                } else {
                    setUser(u => ({ ...u, xp: currentXp }));
                }
            };

            const toggleHabit = (id) => {
                triggerHaptic('success');
                setHabits(habits.map(h => {
                    if(h.id === id) {
                        const currentVal = (h.done[today] || 0);
                        if (currentVal >= h.goal) return h; // Already done

                        const val = currentVal + 1;
                        
                        // XP Logic: 25 XP per habit
                        if (val >= h.goal) { 
                            checkLevelUp(user.xp + 25, user.level);
                            setShowConfetti(true); 
                            setTimeout(() => setShowConfetti(false), 2000); 
                        }

                        return { ...h, done: { ...h.done, [today]: val }, streak: val >= h.goal ? h.streak + 1 : h.streak };
                    }
                    return h;
                }));
            };

            const addFriend = (id) => {
                if(!id || id === user.id || friends.find(f => f.id === id)) return;
                setFriends([...friends, { id, name: 'Friend '+id.slice(-4), avatar: 'ðŸ¦Š', level: Math.floor(Math.random()*10)+1 }]);
                triggerHaptic('success');
            };

            return (
                <LanguageContext.Provider value={{ t, lang }}>
                    <div dir={isRTL ? 'rtl' : 'ltr'} className="min-h-screen pb-32 text-slate-800 relative select-none">
                        <Confetti active={showConfetti} />
                        <div className="blob blob-1"></div><div className="blob blob-2"></div>

                        {/* Header */}
                        <header className="px-6 pt-12 pb-6 sticky top-0 z-30 transition-all">
                            <div className="flex justify-between items-center mb-6">
                                <div className="flex items-center gap-4">
                                    <div className="relative">
                                        <div className="w-14 h-14 rounded-2xl bg-white/80 shadow-lg flex items-center justify-center text-3xl border border-white/60">{user.avatar}</div>
                                        <div className="absolute -bottom-1 -right-1 bg-black text-white text-[10px] font-bold px-1.5 rounded-md border border-white">{user.level}</div>
                                    </div>
                                    <div>
                                        <h1 className="text-gray-500 text-xs font-bold uppercase tracking-widest">{t.welcome}</h1>
                                        <h2 className="text-2xl font-black">{user.name}</h2>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => {triggerHaptic('click'); setLang(lang==='en'?'ar':'en')}} className="w-12 h-12 rounded-2xl bg-white/80 shadow-sm flex items-center justify-center text-2xl">{lang==='en'?'ðŸ‡¸ðŸ‡¦':'ðŸ‡ºðŸ‡¸'}</button>
                                    <button onClick={() => {triggerHaptic('click'); setModal('friends')}} className="w-12 h-12 rounded-2xl bg-white/80 shadow-sm flex items-center justify-center text-2xl relative">
                                        ðŸ‘¥ {friends.length > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[10px] text-white flex items-center justify-center">{friends.length}</span>}
                                    </button>
                                </div>
                            </div>
                            
                            {/* XP BAR */}
                            <div className="mb-4 px-1">
                                <div className="flex justify-between text-xs font-bold text-gray-500 mb-1">
                                    <span>{t.xp} {user.xp} / {user.level * 100}</span>
                                    <span>{t.level} {user.level + 1}</span>
                                </div>
                                <div className="w-full bg-white/50 h-2 rounded-full overflow-hidden">
                                    <div className="h-full bg-gradient-to-r from-violet-500 to-fuchsia-500 transition-all duration-500" style={{width: `${(user.xp / (user.level * 100)) * 100}%`}}></div>
                                </div>
                            </div>
                            
                            {/* AI Badge */}
                            <div className="bg-white/60 backdrop-blur rounded-2xl p-4 flex gap-4 items-center shadow-sm">
                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xl text-white">ðŸ¤–</div>
                                <div><p className="text-[10px] font-bold text-indigo-500 uppercase">{t.aiCoach}</p><p className="text-sm font-bold">{aiMsg}</p></div>
                            </div>
                        </header>

                        {/* Main Content */}
                        <main className="px-6 space-y-6">
                            {/* Hero */}
                            <Card3D className="bg-gradient-to-br from-violet-600 to-fuchsia-600 text-white p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <div><p className="text-white/80 font-bold text-xs uppercase">{t.today}</p><h3 className="text-4xl font-black">{progress}%</h3></div>
                                    <div className="text-4xl">ðŸ”¥</div>
                                </div>
                                <div className="w-full bg-black/20 h-3 rounded-full overflow-hidden"><div className="h-full bg-white transition-all duration-1000" style={{width: `${progress}%`}} /></div>
                            </Card3D>

                            {/* Habits */}
                            <div>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-xl">{t.habits}</h3>
                                    <button onClick={() => {triggerHaptic('click'); setModal('addHabit')}} className="text-violet-600 font-bold text-sm bg-white px-4 py-2 rounded-full shadow-sm">+ {t.newHabit}</button>
                                </div>
                                <div className="space-y-4">
                                    {habits.map(h => {
                                        const done = (h.done[today]||0) >= h.goal;
                                        return (
                                            <Card3D key={h.id} onClick={() => toggleHabit(h.id)} className={`p-4 flex items-center gap-4 ${done ? 'opacity-60' : ''}`}>
                                                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-inner ${done ? 'bg-green-400 text-white' : 'bg-white'}`}>{done ? 'âœ“' : h.emoji}</div>
                                                <div className="flex-1">
                                                    <h4 className={`font-bold text-lg ${done && 'line-through'}`}>{h.name}</h4>
                                                    <div className="text-xs font-bold text-orange-500">ðŸ”¥ {h.streak}</div>
                                                </div>
                                            </Card3D>
                                        )
                                    })}
                                    {habits.length === 0 && <div className="text-center py-12 opacity-50"><div className="text-5xl mb-4">ðŸŒ±</div><p>{t.freeHabits}</p></div>}
                                </div>
                            </div>
                        </main>

                        {/* Nav */}
                        <nav className="fixed bottom-8 left-6 right-6 glass rounded-3xl p-2 shadow-2xl flex justify-between z-40">
                            {['ðŸŽ¯','ðŸ“Š','âš™ï¸'].map((icon, i) => <button key={i} onClick={() => {triggerHaptic('click'); setActiveTab(i)}} className={`flex-1 py-4 rounded-2xl text-2xl transition-all ${activeTab===i ? 'bg-slate-800 text-white shadow-xl -translate-y-4' : 'text-slate-400'}`}>{icon}</button>)}
                        </nav>

                        {/* Modals */}
                        
                        {/* 1. Add Habit */}
                        {modal === 'addHabit' && (
                            <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end justify-center" onClick={() => setModal(null)}>
                                <div className="bg-white w-full max-w-md rounded-t-[32px] p-8 animate-float" onClick={e=>e.stopPropagation()}>
                                    <h2 className="text-2xl font-black mb-6">{t.newHabit}</h2>
                                    <input id="inputHabit" placeholder={t.habitName} className="w-full p-4 bg-slate-100 rounded-2xl mb-4 font-bold outline-none" autoFocus />
                                    <button onClick={() => addHabit(document.getElementById('inputHabit').value)} className="w-full py-4 bg-violet-600 text-white rounded-2xl font-bold shadow-lg">{t.create}</button>
                                </div>
                            </div>
                        )}

                        {/* 2. Friends */}
                        {modal === 'friends' && (
                            <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-md flex items-center justify-center p-4" onClick={() => setModal(null)}>
                                <div className="bg-white w-full max-w-md rounded-[32px] p-6 h-[70vh] flex flex-col" onClick={e=>e.stopPropagation()}>
                                    <div className="bg-slate-900 text-white p-6 rounded-3xl mb-6">
                                        <p className="text-xs font-bold uppercase mb-1">{t.yourId}</p>
                                        <div className="flex justify-between items-center"><code className="text-2xl font-mono font-bold">{user.id}</code><button onClick={()=>{navigator.clipboard.writeText(user.id); triggerHaptic('success')}} className="bg-white/20 px-3 py-1 rounded-lg text-xs">{t.copy}</button></div>
                                    </div>
                                    <div className="flex gap-2 mb-4">
                                        <input id="friendId" placeholder="Friend ID" className="flex-1 p-3 bg-slate-100 rounded-xl font-bold" />
                                        <button onClick={()=>addFriend(document.getElementById('friendId').value)} className="bg-violet-600 text-white px-6 rounded-xl font-bold">+</button>
                                    </div>
                                    <div className="overflow-y-auto flex-1 space-y-2">
                                        {friends.map(f => (
                                            <div key={f.id} className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                                                <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm">{f.avatar}</div>
                                                <div className="flex-1"><h4 className="font-bold">{f.name}</h4><p className="text-xs text-orange-500">Lv.{f.level}</p></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* 3. Level Up Celebration */}
                        {modal === 'levelUp' && (
                            <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-pop">
                                <div className="bg-white w-full max-w-sm rounded-[32px] p-8 text-center relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-400 to-orange-500"></div>
                                    <div className="text-8xl mb-4 animate-float">ðŸŽ‰</div>
                                    <h2 className="text-3xl font-black text-slate-800 mb-2">{t.levelUp}</h2>
                                    <p className="text-slate-500 mb-6 font-bold">{t.level} {user.level}</p>
                                    <div className="bg-slate-100 p-4 rounded-2xl mb-6 border border-slate-200">
                                        <p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">REWARD</p>
                                        <p className="text-xl font-bold text-violet-600">âœ¨ New Avatar Style</p>
                                    </div>
                                    <button onClick={() => setModal(null)} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-xl active:scale-95 transition-transform">{t.continue}</button>
                                </div>
                            </div>
                        )}
                    </div>
                </LanguageContext.Provider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
